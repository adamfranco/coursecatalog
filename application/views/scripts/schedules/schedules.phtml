<?php

foreach ($this->schedules as $schedule) {
	print "\n<div class='schedule'>";
	
	print "\n\t<form class='delete_schedule' action='".$this->url(array('action' => 'delete'))."' method='post'>";
	print "\n\t\t<input type='hidden' name='schedule_id' value='".$this->escape($schedule->getId())."'/>";
	print "\n\t\t<input type='hidden' name='csrf_key' value='".$this->csrfKey()."' />";
	print "\n\t\t<input type='submit' value='Delete'/>";
	print "\n\t</form>";
	
	print "\n\t<form action='".$this->url(array('action' => 'update'))."' method='post'>";
	print "\n\t\t<input type='text' name='name' value=\"".$this->escape($schedule->getName())."\"/>";
	print "\n\t\t<input type='hidden' name='schedule_id' value='".$this->escape($schedule->getId())."'/>";
	print "\n\t\t<input type='hidden' name='csrf_key' value='".$this->csrfKey()."' />";
	print "\n\t\t<input type='submit' value='Save Name'/>";
	print "\n\t</form>";
	
	print "\n\t<button class='calendar_button' href='".$this->url(array('action' => 'eventsjson', 'schedule_id' => $schedule->getId()))."'>Calendar</button>";
	print "\n\t<div class='calendar' style='display: none;' title=\"".$this->escape($schedule->getName())."\"></div>";
	
	print "\n\t\t<ul>";
	foreach ($schedule->getOfferings() as $offering) {
		print "\n\t\t\t<li class='offering'>";
		
		print "\n\t\t<div class='offering_name'>";
		print "\n\t\t\t<a href='".$this->url(array('controller' => 'offerings', 'action' => 'view', 'offering' => $this->getStringFromOsidId($offering->getId())))."' target='_blank'>";
		print $this->escape($offering->getDisplayName());
		print "</a>";
		print "\n\t\t</div>";
		
		print "\n\t\t<div class='separator'> - </div>";
		
		print "\n\t\t<div class='offering_title'>";
		print "\n\t\t\t<a href='".$this->url(array('controller' => 'offerings', 'action' => 'view', 'offering' => $this->getStringFromOsidId($offering->getId())))."' target='_blank'>";
		print nl2br($this->escape($offering->getTitle()));
		print "</a>";
		print "\n\t\t</div>";
		
		print "\n\t\t<form class='remove_offering' action='".$this->url(array('action' => 'remove'))."' method='post'>";
		print "\n\t\t\t<input type='hidden' name='csrf_key' value='".$this->csrfKey()."'/>";
		print "\n\t\t\t<input type='hidden' name='schedule_id' value='".$schedule->getId()."'/>";
		print "\n\t\t\t<input type='hidden' name='offering' value='".$this->getStringFromOsidId($offering->getId())."'>";
		print "\n\t\t\t<input type='submit' title='Remove from the schedule.' value='X'/>";
		print "\n\t\t\t<input type='hidden' name='course_name' value='".$this->escape($offering->getCourse()->getDisplayName())."'/>";
		print "\n\t\t</form>";
		
		print "\n\t\t<div class='time'>".nl2br($this->escape($offering->getScheduleInfo()))."</div>";
		print "\n\t\t<div class='location'>".nl2br($this->escape($offering->getLocationInfo()))."</div>";
		
		print "\n\t\t\t</li>";
	}
	print "\n\t\t</ul>";
	
	print "\n</div>";
}

?>

<form id='schedule_create' action="<?php print $this->url(array('action' => 'create')); ?>" method="post">
	<input type="submit" value="Create new schedule"/> for 
	<?php print $this->render('schedules/terms.phtml'); ?>
	
	<input type="hidden" name="catalog" value="<?php print $this->escape($this->getStringFromOsidId($this->menuCatalogSelectedId)); ?>" />
	<input type="hidden" name="csrf_key" value="<?php print $this->csrfKey(); ?>" />
</form>

<?php ob_start(); ?>

	$(function() { // on DOM ready 
		
		$('form.delete_schedule').submit(function () {
			return confirm('Are you sure you want to delete this schedule?');	
		});
		
		$('form.remove_offering').submit(function () {
			return confirm('Remove all sections of ' + $(this).find('[name=course_name]').val() + " from this schedule? \n\nHint: You can add the course to the schedule again to change which sections are chosen.");
		});
		
		
		/*********************************************************
		 * Calendar controls
		 *********************************************************/
		<?php
		$this->headLink()->appendStylesheet($this->url(array(), null, true).'javascript/jquery-week-calendar/jquery.weekcalendar.css');
		$this->headStyle()->appendStyle('
			div.wc-toolbar {display: none;}
			.wc-time-slots .wc-today { background-color: #FFF; }
			.wc-header .wc-today { font-weight: normal; }
		');
		$this->headScript()->appendFile($this->url(array(), null, true).'javascript/jquery-week-calendar/libs/date.js');
		$this->headScript()->appendFile($this->url(array(), null, true).'javascript/jquery-week-calendar/jquery.weekcalendar.js');
		?>
		
		$(".calendar").each(function() {
			var button = $(this).siblings(".calendar_button");
			var calendar = $(this).dialog({
					autoOpen: false, 
					width:  900, 
					modal: true,
					position: 'top'
				});
			
			button.data("calendar", calendar);
		});
		$(".calendar_button").click(function(){
			var jsonUrl = $(this).attr('href');
			var calendar = $(this).data('calendar');
			calendar.dialog("open");
			
			if (!calendar.data('initialized')) {
			
				var year = new Date().getFullYear();
				var month = new Date().getMonth();
				var day = new Date().getDate();
				
				calendar.weekCalendar({
					readonly: true,
					allowCalEventOverlap: true,
					overlapEventsSeparate: true,
					timeslotsPerHour: 4,
					height: function($calendar){
						return $(window).height() - $("h1").outerHeight(true);
					},
					eventRender : function(calEvent, $event) {
// 						if(calEvent.end.getTime() < new Date().getTime()) {
// 							$event.css("backgroundColor", "#aaa");
// 							$event.find(".time").css({"backgroundColor": "#999", "border":"1px solid #888"});
// 						}
					},
					noEvents : function() {
						displayMessage("There are no events for this week");
					},
					data: jsonUrl
				});
				
				calendar.find('td.wc-day-column-header').each(function() {
					$(this).html($(this).html().replace(/<.*$/, ''));
				});
				calendar.data('initialized', true)
			}
			
		});
		
	});


<?php

$this->headScript()->appendScript(ob_get_clean());